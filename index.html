<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ALGO ONLINE Ver3.0</title>
<style>
  body { background:#222; color:#eee; font-family:"Segoe UI",sans-serif; text-align:center; margin:0; padding:0; }
  h1 { background:#333; margin:0; padding:12px; font-size:24px; }
  .screen { display:none; }
  .active { display:block; }
  .board { display:flex; justify-content:center; gap:8px; margin:10px; }
  .card {
    width:50px; height:70px; border-radius:6px;
    display:flex; justify-content:center; align-items:center;
    font-weight:bold; cursor:pointer; border:1px solid #888;
  }
  .white{background:#fff;color:#000;}
  .black{background:#000;color:#fff;}
  .hidden{background:#555;color:transparent;border:1px solid #aaa;}
  button {margin:5px;padding:10px 14px;font-size:16px;border:none;border-radius:6px;cursor:pointer;}
  #numberButtons button{background:#444;color:#fff;}
  #stayBtn{background:#777;color:#fff;}
  #resetBtn{background:#a33;color:#fff;}
  #numberButtons button:hover,#stayBtn:hover,#resetBtn:hover{background:#999;}
  #status{font-size:18px;margin:10px;}
  input{padding:8px;font-size:16px;}
</style>
</head>
<body>
  <h1>ALGO ONLINE <small>Ver3.0</small></h1>

  <!-- ロビー画面 -->
  <div id="lobby" class="screen active">
    <p><button id="createRoom">ゲームコード発行</button></p>
    <p>または<br>コードを入力して入室：</p>
    <input type="text" id="joinCode" maxlength="4" placeholder="例: 4823">
    <button id="joinRoom">入室する</button>
    <p id="lobbyMessage"></p>
  </div>

  <!-- ゲーム画面 -->
  <div id="game" class="screen">
    <div id="status"></div>
    <h2>相手</h2>
    <div id="opponentBoard" class="board"></div>

    <h2>自分</h2>
    <div id="playerBoard" class="board"></div>

    <div id="numberButtons"></div>
    <button id="stayBtn">ステイ</button>
    <button id="resetBtn">初期化</button>
    <div id="message"></div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getDatabase, ref, set, get, update, onValue, remove } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

// Firebase設定
const firebaseConfig = {
  apiKey: "AIzaSyB9WONjuFuyxQg9T7zV34-LA7mIp7QvwR0",
  authDomain: "algo-e0da0.firebaseapp.com",
  databaseURL: "https://algo-e0da0-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "algo-e0da0",
  storageBucket: "algo-e0da0.firebasestorage.app",
  messagingSenderId: "87259521629",
  appId: "1:87259521629:web:35953641ebd0c4a8f123b4"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let roomId=null;
let playerId=null;
let opponentId=null;
let state=null;
let selectedTarget=null;

// カード生成補助
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}}
function sortCards(cards){cards.sort((a,b)=>(a.num===b.num?(a.color==="black"?-1:1):a.num-b.num));}

// ロビー操作
document.getElementById("createRoom").onclick=async()=>{
  roomId=Math.floor(1000+Math.random()*9000).toString();
  playerId="white"; opponentId="black";
  await createNewRoom(roomId);
  document.getElementById("lobbyMessage").textContent=`コード ${roomId} を相手に伝えてください。`;
  switchToGame();
};

document.getElementById("joinRoom").onclick=async()=>{
  roomId=document.getElementById("joinCode").value.trim();
  if(roomId.length!==4){alert("4桁のコードを入力");return;}
  const snap=await get(ref(db,`rooms/${roomId}`));
  if(!snap.exists()){alert("ルームが存在しません");return;}
  playerId="black"; opponentId="white";
  await update(ref(db,`rooms/${roomId}/players/black`),{connected:true});
  switchToGame();
};

// ルーム新規作成
async function createNewRoom(id){
  const deck=[];["white","black"].forEach(c=>{for(let n=0;n<=11;n++)deck.push({num:n,color:c});});
  shuffle(deck);
  const whiteCards=deck.splice(0,4), blackCards=deck.splice(0,4);
  sortCards(whiteCards); sortCards(blackCards);
  const data={
    players:{
      white:{cards:whiteCards,connected:true},
      black:{cards:blackCards,connected:false}
    },
    deck, turn:"white", message:"", winner:null
  };
  await set(ref(db,`rooms/${id}`),data);
}

// 画面切替
function switchToGame(){
  document.getElementById("lobby").classList.remove("active");
  document.getElementById("game").classList.add("active");
  startGameListener();
}

// Firebase購読
function startGameListener(){
  onValue(ref(db,`rooms/${roomId}`),snap=>{
    if(!snap.exists())return;
    state=snap.val();
    if(state.players.white.connected&&state.players.black.connected){
      render();
    }
  });
}

// 描画
function render(){
  const my=state.players[playerId], op=state.players[opponentId];
  document.getElementById("status").textContent=
    state.winner?`${state.winner}の勝ち！`:
    state.turn===playerId?"あなたの番です":"相手の番です";

  const pb=document.getElementById("playerBoard");
  pb.innerHTML="";
  my.cards.forEach(c=>{
    const div=document.createElement("div");
    div.className=`card ${c.color} ${c.open?"":"hidden"}`;
    div.textContent=c.open?c.num:"?";
    pb.appendChild(div);
  });

  const ob=document.getElementById("opponentBoard");
  ob.innerHTML="";
  op.cards.forEach((c,i)=>{
    const div=document.createElement("div");
    div.className=`card ${c.open?c.color:"hidden"}`;
    div.textContent=c.open?c.num:"?";
    if(state.turn===playerId&&!c.open)div.onclick=()=>{selectedTarget=i;};
    ob.appendChild(div);
  });

  document.getElementById("message").textContent=state.message||"";
  const btns=document.querySelectorAll("#numberButtons button,#stayBtn");
  btns.forEach(b=>b.disabled=state.turn!==playerId||state.winner);
}

for(let n=0;n<=11;n++){
  const btn=document.createElement("button");
  btn.textContent=n;
  btn.onclick=()=>attack(n);
  document.getElementById("numberButtons").appendChild(btn);
}
document.getElementById("stayBtn").onclick=()=>stayTurn();
document.getElementById("resetBtn").onclick=()=>resetRoom();

// 攻撃処理
async function attack(num){
  if(selectedTarget==null)return;
  const op=state.players[opponentId];
  const my=state.players[playerId];
  const target=op.cards[selectedTarget];
  let msg="";
  if(target.num===num){
    target.open=true;
    msg=`正解！${num}`;
    if(op.cards.every(c=>c.open))state.winner=playerId;
  }else{
    msg=`失敗…${num}ではなかった`;
    const unopened=my.cards.find(c=>!c.open);
    if(unopened)unopened.open=true;
    else state.winner=opponentId;
    state.turn=opponentId;
  }
  state.message=msg;
  selectedTarget=null;
  await update(ref(db,`rooms/${roomId}`),state);
}

// ステイ
async function stayTurn(){
  state.turn=opponentId;
  state.message="ステイしました";
  await update(ref(db,`rooms/${roomId}`),state);
}

// リセット
async function resetRoom(){
  if(!roomId)return;
  await remove(ref(db,`rooms/${roomId}`));
  location.reload();
}
</script>
</body>
</html>
