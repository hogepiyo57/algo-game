<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ALGO ONLINE Ver2.2</title>
<style>
  body { background: #222; color: #eee; font-family: "Segoe UI", sans-serif; text-align: center; margin: 0; padding: 0; }
  h1 { background: #333; margin: 0; padding: 12px; font-size: 24px; }
  #status { font-size: 18px; margin: 10px; }
  .board { display: flex; justify-content: center; gap: 8px; margin: 10px; }
  .card {
    width: 50px; height: 70px; border-radius: 6px;
    display: flex; justify-content: center; align-items: center;
    font-weight: bold; cursor: pointer; border: 1px solid #888; user-select: none;
  }
  .white { background: #fff; color: #000; }
  .black { background: #000; color: #fff; }
  .hidden { background: #555; color: transparent; border: 1px solid #aaa; }
  #numberButtons button, #stayBtn, #resetBtn {
    margin: 5px; padding: 10px 14px; font-size: 16px;
    cursor: pointer; border: none; border-radius: 6px;
  }
  #numberButtons button { background: #444; color: #fff; }
  #stayBtn { background: #777; color: #fff; }
  #resetBtn { background: #a33; color: #fff; }
  #numberButtons button:hover, #stayBtn:hover, #resetBtn:hover { background: #999; }
  #message { margin-top: 12px; height: 24px; }
</style>
</head>
<body>
  <h1>ALGO ONLINE <small>Ver2.2</small></h1>
  <button id="resetBtn">初期化</button>
  <div id="status"></div>

  <h2>相手</h2>
  <div id="opponentBoard" class="board"></div>

  <h2>自分</h2>
  <div id="playerBoard" class="board"></div>

  <div id="numberButtons"></div>
  <button id="stayBtn">ステイ</button>
  <div id="message"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getDatabase, ref, set, get, onValue, update, remove } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

// ================== Firebase設定 ==================
const firebaseConfig = {
  apiKey: "AIzaSyB9WONjuFuyxQg9T7zV34-LA7mIp7QvwR0",
  authDomain: "algo-e0da0.firebaseapp.com",
  databaseURL: "https://algo-e0da0-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "algo-e0da0",
  storageBucket: "algo-e0da0.firebasestorage.app",
  messagingSenderId: "87259521629",
  appId: "1:87259521629:web:35953641ebd0c4a8f123b4"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ================== ゲームデータ ==================
const roomId = "demo-room"; // テスト用固定
const playerId = Math.random() < 0.5 ? "white" : "black";
const opponentId = playerId === "white" ? "black" : "white";

let state = {
  deck: [],
  players: { white: { cards: [] }, black: { cards: [] } },
  turn: "white",
  message: "",
  winner: null
};

// ================== 強制初期化 ==================
document.getElementById("resetBtn").onclick = async () => {
  await remove(ref(db, `rooms/${roomId}`)); // 前データ削除
  const deck = [];
  ["white", "black"].forEach(color => {
    for (let n = 0; n <= 11; n++) deck.push({ num: n, color });
  });
  shuffle(deck);

  const whiteCards = deck.splice(0, 4);
  const blackCards = deck.splice(0, 4);
  sortCards(whiteCards);
  sortCards(blackCards);

  state = {
    deck,
    players: {
      white: { cards: whiteCards },
      black: { cards: blackCards }
    },
    turn: "white",
    message: "新しいカードを配りました。",
    winner: null
  };

  await set(ref(db, `rooms/${roomId}`), state);
  render();
  alert("初期化完了。カードを再配布しました。");
};

// ================== 初期化処理 ==================
async function initGame() {
  const snapshot = await get(ref(db, `rooms/${roomId}`));
  if (snapshot.exists()) {
    state = snapshot.val();
  } else {
    document.getElementById("message").textContent = "初期化ボタンで開始してください。";
  }
  onValue(ref(db, `rooms/${roomId}`), snap => {
    if (snap.exists()) {
      state = snap.val();
      render();
    }
  });
}

function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }
function sortCards(cards){
  cards.sort((a,b)=>(a.num===b.num ? (a.color==="black"?-1:1) : a.num-b.num));
}

// ================== 描画 ==================
function render() {
  const my = state.players[playerId];
  const op = state.players[opponentId];

  document.getElementById("status").textContent =
    state.winner ? `${state.winner}の勝ち！` :
    state.turn === playerId ? "あなたの番です" : "相手の番です";

  const pb = document.getElementById("playerBoard");
  pb.innerHTML = "";
  if (my && my.cards) {
    my.cards.forEach((c,i)=>{
      const div=document.createElement("div");
      div.className=`card ${c.color} ${c.open?"":"hidden"}`;
      div.textContent=c.open?c.num:"?";
      pb.appendChild(div);
    });
  }

  const ob = document.getElementById("opponentBoard");
  ob.innerHTML = "";
  if (op && op.cards) {
    op.cards.forEach((c,i)=>{
      const div=document.createElement("div");
      div.className=`card ${c.open?c.color:"hidden"}`;
      div.textContent=c.open?c.num:"?";
      if(state.turn===playerId && !c.open){
        div.onclick=()=>selectTarget(i);
      }
      ob.appendChild(div);
    });
  }

  document.getElementById("message").textContent = state.message || "";

  const buttons = document.querySelectorAll("#numberButtons button, #stayBtn");
  buttons.forEach(b=>{
    b.disabled = state.turn !== playerId || state.winner;
  });
}

function selectTarget(i){
  selectedTarget = i;
  document.getElementById("message").textContent = `相手の${i+1}番を選択中`;
}

let selectedTarget = null;
const nb = document.getElementById("numberButtons");
for(let n=0;n<=11;n++){
  const btn=document.createElement("button");
  btn.textContent=n;
  btn.onclick=()=>attack(n);
  nb.appendChild(btn);
}
document.getElementById("stayBtn").onclick=()=>stayTurn();

// ================== アクション ==================
async function attack(num){
  if(selectedTarget===null) return;
  const op = state.players[opponentId];
  const my = state.players[playerId];
  const target = op.cards[selectedTarget];

  let msg="";
  if(target.num===num){
    target.open=true;
    msg=`正解！相手の${selectedTarget+1}番は${num}`;
    if(op.cards.every(c=>c.open)){
      state.winner=playerId;
      msg="勝利！";
    }
  } else {
    msg=`失敗…${num}ではなかった`;
    const unopened=my.cards.find(c=>!c.open);
    if(unopened){ unopened.open=true; }
    else { state.winner=opponentId; msg="敗北…"; }
    state.turn=opponentId;
  }

  state.message=msg;
  await update(ref(db,`rooms/${roomId}`),state);
  selectedTarget=null;
}

async function stayTurn(){
  state.turn=opponentId;
  state.message="ステイしました";
  await update(ref(db,`rooms/${roomId}`),state);
}

// ================== ターン開始時：自動ドロー ==================
onValue(ref(db, `rooms/${roomId}/turn`), async snap => {
  const turn = snap.val();
  if(turn===playerId && state.deck.length>0){
    const card = state.deck.pop();
    state.players[playerId].cards.push(card);
    sortCards(state.players[playerId].cards);
    await update(ref(db,`rooms/${roomId}`),state);
  }
});

// ================== 起動 ==================
initGame();
</script>
</body>
</html>
